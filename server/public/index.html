<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Agenda semanal</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">

<style>
body{font-family:Montserrat;background:#f5f5f5;padding:40px;}

.header{display:flex;justify-content:center;gap:20px;margin-bottom:20px;}

.calendar-wrapper{
  overflow-x:auto;
  width:100%;
}

.calendar-wrapper{
  overflow-x:auto;
  width:100%;
  -webkit-overflow-scrolling: touch;
}


.calendar{
  display:grid;
  grid-template-columns:80px repeat(7,1fr);
  background:#fff;
  border:1px solid #ddd;
}


/* lÃ­neas SIEMPRE visibles */
.hour{
  border-bottom:1px solid #eee;
  padding:5px;
  font-size:12px;
}

.day-header{
  border-left:1px solid #eee;
  border-bottom:1px solid #eee;
  padding:10px;
  text-align:center;
  font-weight:600;
}

.cell{
  height:40px;
border-left:1px solid rgba(0,0,0,0.1);
border-bottom:1px solid rgba(0,0,0,0.1);

}


/* COLORES */
.available{background:#7FC06A;cursor:pointer;}
.pending{background:#E8DE6C;}
.confirmed{background:#e74c3c;}
.closed{background:#EDEDED;} /* gris pero con lÃ­neas visibles */

.cell.closed,
.cell.pending,
.cell.confirmed{
  cursor:default;
}


/* POPUP BONITO ORIGINAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  align-items:center;
  justify-content:center;
}

.form{
  background:#fff;
  padding:20px;
  border-radius:10px;
  width:300px;
  display:flex;
  flex-direction:column;
  gap:10px;
  position:relative;
}

.close{
  position:absolute;
  right:15px;
  top:10px;
  cursor:pointer;
  font-size:18px;

  
}

input,select{
  padding:8px;
  border:1px solid #ccc;
  border-radius:6px;
}

button{
  padding:10px;
  border:none;
  background:#000;
  color:#fff;
  border-radius:6px;
  cursor:pointer;
}

@media (max-width:768px){
  .calendar{
    min-width:900px;
  }

  body{
    padding:15px;
  }

  .form{
    width:90%;
  }
}

.today-header{
  background:#000;
  color:white;
}

.today-cell{
  background:rgba(0,0,0,0.05);
}

/* ANIMACIÃ“N RESERVA OK */
.success-anim{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:999;
}

.success-anim .check{
  font-size:60px;
  color:#2ecc71;
  animation:pop 0.4s ease;
}

.success-anim .msg{
  margin-top:10px;
  font-weight:600;
  color:white;
}

@keyframes pop{
  0%{transform:scale(0.2); opacity:0;}
  80%{transform:scale(1.2);}
  100%{transform:scale(1); opacity:1;}
}


</style>
</head>

<body>

<div class="header">
  <button onclick="prevWeek()">â—€</button>
  <div id="title"></div>
  <button onclick="nextWeek()">â–¶</button>
</div>

<div class="calendar-wrapper">
  <div id="calendar" class="calendar"></div>
</div>



<div id="modal" class="modal">
  <div class="form">
    <div class="close" onclick="closeModal()">âœ–</div>

    <h3 id="selectedInfo"></h3>

    <input id="name" placeholder="Nombre" required>
    <input id="lastname" placeholder="Apellidos" required>
    <input id="email" placeholder="Email" required>
    <input id="phone" placeholder="TelÃ©fono" required>

    <select id="duration">
      <option value="1">1 hora</option>
      <option value="2">2 horas</option>
      <option value="3">3 horas</option>
      <option value="4">4 horas</option>
    </select>

    <button onclick="submitBooking()">Enviar reserva</button>
  </div>
</div> <!-- ðŸ‘ˆ ESTE ES EL QUE TE FALTA -->

<!-- ðŸ‘‡ ANIMACIÃ“N FUERA DEL MODAL -->
<div id="successAnim" class="success-anim">
  <div class="check">âœ”</div>
  <div class="msg">âœ” Reserva enviada</div>
</div>

<script>



let currentDate = new Date();
let bookings = [];
let confirmedBookings = [];
let selected = {day:null,hour:null};

/* CARGAR RESERVAS */
async function loadBookings(){

  const res = await fetch("http://localhost:3000/bookings");
  const data = await res.json();

  bookings = [];
  confirmedBookings = [];

  data.forEach(b => {

    const hour = parseInt(b.time);

    // ðŸ‘‰ marcar todas las horas de la duraciÃ³n
    for(let i = 0; i < b.duration; i++){

      if(b.status === "confirmed"){
        confirmedBookings.push({
          date: b.date,
          hour: hour + i
        });

      } else {
        bookings.push({
          date: b.date,
          hour: hour + i
        });
      }

    }

  });

}






/* CALCULAR SEMANA */
function startOfWeek(date){
  const d=new Date(date);
  const day=d.getDay()||7;
  if(day!==1)d.setHours(-24*(day-1));
  return d;
}

/* RENDER */
async function render(){

  await loadBookings();

  const calendar=document.getElementById("calendar");
  calendar.innerHTML="";

  const start=startOfWeek(currentDate);

  document.getElementById("title").innerText=
    start.toLocaleDateString()+" - "+
    new Date(start.getTime()+6*86400000).toLocaleDateString();

  calendar.appendChild(document.createElement("div"));

  for(let i=0;i<7;i++){
    const day=new Date(start.getTime()+i*86400000);
    const el=document.createElement("div");
    el.className="day-header";
    el.innerText=day.toLocaleDateString("es-ES",{weekday:"short",day:"numeric"});
    calendar.appendChild(el);
  }

  for(let h=0;h<24;h++){

    const hour=document.createElement("div");
    hour.className="hour";
    hour.innerText=h+":00";
    calendar.appendChild(hour);

    for(let d=0;d<7;d++){

      const cell=document.createElement("div");
      cell.className="cell";

      // ðŸ”¥ FECHA REAL DE ESTA CELDA
const fechaCelda = new Date(start.getTime() + d*86400000);

const yyyy = fechaCelda.getFullYear();
const mm = ("0"+(fechaCelda.getMonth()+1)).slice(-2);
const dd = ("0"+fechaCelda.getDate()).slice(-2);

const fechaStr = `${yyyy}-${mm}-${dd}`;


      let available=false;

      if(d>=1 && d<=3 && h>=10 && h<20) available=true;
      if(d===4 && ((h>=10 && h<13) || h>=16)) available=true;
      if(d===5 && ((h<5) || h>=16)) available=true;
      if(d===6 && h<5) available=true;

      const pending = bookings.find(b => b.date === fechaStr && b.hour === h);
      const confirmed = confirmedBookings.find(b => b.date === fechaStr && b.hour === h);

      const ocupado = pending || confirmed;

      if(confirmed) cell.classList.add("confirmed");
      else if(pending) cell.classList.add("pending");
      else if(available) cell.classList.add("available");
      else cell.classList.add("closed");

      if(available && !ocupado){
        cell.onclick = () => {

          selected={day:d,hour:h};
          const hoy = new Date();
const inicioSemana = startOfWeek(currentDate);

const fechaReal = new Date(inicioSemana);
fechaReal.setDate(inicioSemana.getDate() + d);

const dd = ("0"+fechaReal.getDate()).slice(-2);
const mm = ("0"+(fechaReal.getMonth()+1)).slice(-2);

document.getElementById("selectedInfo").innerText =
  "Reserva para " + dd + "/" + mm + " a las " + h + ":00";

          document.getElementById("modal").style.display="flex";
        }
      }

      calendar.appendChild(cell);
    }
  }
}

/* ENVIAR RESERVA */
async function submitBooking(){

  const name=document.getElementById("name").value;
  const lastname=document.getElementById("lastname").value;
  const email=document.getElementById("email").value;
  const phone=document.getElementById("phone").value;
  const duration=parseInt(document.getElementById("duration").value);

  if(!email.includes("@") || !email.includes(".")){
    alert("Por favor introduce un email vÃ¡lido");
    return;
  }

  if(phone.trim() === ""){
    alert("Por favor introduce un telÃ©fono");
    return;
  }

  try {

    const inicioSemana = startOfWeek(currentDate);

    const fechaReal = new Date(inicioSemana);
    fechaReal.setDate(inicioSemana.getDate() + selected.day);

    const yyyy = fechaReal.getFullYear();
    const mm = ("0" + (fechaReal.getMonth()+1)).slice(-2);
    const dd = ("0" + fechaReal.getDate()).slice(-2);

    const fechaFinal = `${yyyy}-${mm}-${dd}`;

    const res = await fetch("http://localhost:3000/book",{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        date: fechaFinal,
        time: selected.hour,
        duration,
        name,
        lastname,
        email,
        phone
      })
    });

    if(!res.ok){
      alert("Error al guardar la reserva");
      return;
    }

    const data = await res.json();

    if(!data.ok){
      alert("Error al guardar la reserva");
      return;
    }

    closeModal();
    document.getElementById("successAnim").style.display = "flex";

setTimeout(()=>{
  document.getElementById("successAnim").style.display = "none";
  render();
}, 1200);


  } catch(e){
    console.error(e);
    alert("No se puede conectar con el servidor");
  }
}




function closeModal(){
  document.getElementById("modal").style.display = "none";

  document.getElementById("name").value = "";
  document.getElementById("lastname").value = "";
  document.getElementById("email").value = "";
  document.getElementById("phone").value = "";
}


function prevWeek(){currentDate.setDate(currentDate.getDate()-7);render();}
function nextWeek(){currentDate.setDate(currentDate.getDate()+7);render();}

render();

</script>

</body>
</html>
